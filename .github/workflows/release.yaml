name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
env:
  GO_VERSION: 1.22

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Install libpcap
        run: sudo apt-get install -y libpcap-dev
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Go Environment
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      # 缓存 Go 模块依赖和构建缓存
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - name: Login Huawei-Cloud SWR
        uses: docker/login-action@v3
        with:
          registry: swr.cn-east-3.myhuaweicloud.com
          username: ${{ secrets.HUAWEI_SWR_USERNAME }}
          password: ${{ secrets.HUAWEI_SWR_PASSWORD }}
      - name: Delete old release assets (if exists)
        run: |
          # 获取 Release ID 和资源文件
          RELEASE_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/caapap/categraf/releases/tags/${{ github.ref_name }}")
          
          RELEASE_ID=$(echo "$RELEASE_RESPONSE" | python3 -c "import sys, json; data = json.load(sys.stdin); print(data.get('id', ''))" 2>/dev/null || echo "")
          
          if [ -n "$RELEASE_ID" ] && [ "$RELEASE_ID" != "None" ]; then
            echo "Found release ID: $RELEASE_ID, deleting old assets..."
            # 获取所有资源文件
            ASSETS_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/caapap/categraf/releases/$RELEASE_ID/assets")
            
            # 使用 Python 提取所有资源文件 ID
            ASSET_IDS=$(echo "$ASSETS_RESPONSE" | python3 -c "import sys, json; assets = json.load(sys.stdin); [print(asset['id']) for asset in assets]" 2>/dev/null || echo "")
            
            # 删除每个资源文件
            if [ -n "$ASSET_IDS" ]; then
              for ASSET_ID in $ASSET_IDS; do
                echo "Deleting asset ID: $ASSET_ID"
                curl -X DELETE -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                  "https://api.github.com/repos/caapap/categraf/releases/assets/$ASSET_ID" || true
              done
              echo "Old assets deleted successfully"
            else
              echo "No assets found in release"
            fi
          else
            echo "No existing release found, skipping asset deletion"
          fi
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v5
        with:
          version: latest
          args: release --clean --timeout 60m
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: 验证华为云 SWR 镜像推送
        run: |
          # GoReleaser 已自动构建并推送镜像到华为云 SWR
          # 验证镜像是否存在
          echo "验证华为云 SWR 镜像..."
          docker pull swr.cn-east-3.myhuaweicloud.com/caapap/categraf:${{ github.ref_name }}-amd64 || echo "AMD64 镜像可能尚未推送"
          docker pull swr.cn-east-3.myhuaweicloud.com/caapap/categraf:${{ github.ref_name }}-arm64v8 || echo "ARM64 镜像可能尚未推送"
